/**
 *    ReadMore Test
 *
 */
define(["component/ReadMore"], function(ReadMore) {

    // module sets the category of the tests that are about to run.
    QUnit.module("ReadMore");

    QUnit.test("getLocationsOfWordsAndTags", function(assert) {
        var rm = ReadMore();
        var testCopy = "Hello, world!";
        var actual = rm.getLocationsOfWordsAndTags(testCopy);
        var expected = [{content: "Hello,", index: 0, type: "text"}, {content: "world!", index: "Hello, ".length, type: "text"}];
        assert.deepEqual(actual, expected, "getLocationOfWordsAndTags splits as expected for plain strings.");


        testCopy = 'foo <span class=\'tooltip-trigger disclaimer\' data-disclaimers=\'[{"code":"FLOORMAT4","isTerms":false,"body":"FLOORMAT4"}]\'><span class=\'asterisk\'>*</span></span>.';
        actual = rm.getLocationsOfWordsAndTags(testCopy);
        expected = [
            {content: "foo", index: 0, type: "text"},
            {content: '<span class=\'tooltip-trigger disclaimer\' data-disclaimers=\'[{"code":"FLOORMAT4","isTerms":false,"body":"FLOORMAT4"}]\'><span class=\'asterisk\'>*</span></span>', index: 4, type: "disclaimerTag"},
            {content: ".", index: 'foo <span class=\'tooltip-trigger disclaimer\' data-disclaimers=\'[{"code":"FLOORMAT4","isTerms":false,"body":"FLOORMAT4"}]\'><span class=\'asterisk\'>*</span></span>'.length, type: "text"}
        ];
        assert.deepEqual(actual, expected, "getLocationOfWordsAndTags splits disclaimers as one piece.");


        testCopy = '<b>bold</b> <br> foo';
        actual = rm.getLocationsOfWordsAndTags(testCopy);
        expected = [
            {content: "<b>", index: 0, type: "openTag"},
            {content: "bold", index: 3, type: "text"},
            {content: "</b>", index: 7, type: "closeTag"},
            {content: "<br>", index: "<b>bold</b> ".length, type: "selfClosingTag"},
            {content: "foo", index: "<b>bold</b> <br> ".length, type: "text"}
        ];
        assert.deepEqual(actual, expected, "treat other tags as open or close or br tags.");
    });

    QUnit.test("getIndexOfReadMoreBreak", function(assert) {
        var rm = ReadMore();
        var testCopy = 'Brave the elements in style with a set of all-weather floor mats<span class=\'tooltip-trigger disclaimer\' data-disclaimers=\'[{"code":"FLOORMAT4","isTerms":false,"body":"FLOORMAT4"}]\'><span class=\'asterisk\'>*</span></span>. Constructed from a high-quality thermoplastic polymer, these lightweight and durable all-weather floor mats help protect the original factory carpet of your IS, while their distinctive ribbed channel design helps contain moisture, dirt and other debris. Easy to clean, the mats feature a nibbed backing, as well as quarter-turn fasteners on the driver and front passenger mats, which help hold the mats securely in place. The driver and front passenger mats feature a Lexus IS logo and are 100% recyclable.';

        assert.equal(rm.getIndexOfReadMoreBreak(testCopy, 12), 9, "Doesn't bisect words.");
        assert.equal(rm.getIndexOfReadMoreBreak(testCopy, Infinity), -1, "Returns -1 if it never encounters the breakpoint");
        assert.equal(rm.getIndexOfReadMoreBreak(testCopy, 1), 0, "the breakpoint is at the beginning if the first word is past the maxlength");

        var maxlength = 'Brave the elements in style with a set of all-weather floor mats*. Constructed'.length;
        var output = "Brave the elements in style with a set of all-weather floor mats<span class=\'tooltip-trigger disclaimer\' data-disclaimers=\'[{\"code\":\"FLOORMAT4\",\"isTerms\":false,\"body\":\"FLOORMAT4\"}]\'><span class=\'asterisk\'>*</span></span>. Constructed".length;
        assert.equal(rm.getIndexOfReadMoreBreak(testCopy, maxlength), output, "Ignoredisclaimer inputs.");

        testCopy = 'The SmartAccess<span class="tooltip-trigger disclaimer" data-disclaimers="[{&quot;code&quot;:&quot;SMRTACCS&quot;,&quot;isTerms&quot;:false,&quot;body&quot;:&quot;The SmartAccess system may interfere with some pacemakers or cardiac defibrillators. If you have one of these medical devices, please talk to your doctor to see if you should deactivate this system.&quot;},{&quot;code&quot;:&quot;ENGIMM3&quot;,&quot;isTerms&quot;:false,&quot;body&quot;:&quot;The engine immobilizer is a state-of-the-art anti-theft system. When you insert your key into the ignition switch or bring a SmartAccess fob into the vehicle, the key transmits an electronic code to the vehicle. The engine will only start if the code in the transponder chip inside the key/fob matches the code in the vehicle&amp;apos;s immobilizer. Because the transponder chip is embedded in the key/fob, it can be costly to replace. If you lose a key or fob, your Lexus dealer can help. Alternatively, you can find a qualified independent locksmith to perform high-security key services by consulting your local &lt;em&gt;Yellow Pages&lt;/em&gt; or by contacting www.aloa.org.&quot;}]"><span class="asterisk">*</span></span><sup class="disclaimer-counters">30</sup> keyfob lets you lock and unlock your doors and start the push-button ignition—all without having to take your keys out of your pocket or purse. As soon as the sensors detect the presence of your SmartAccess key, the door unlocks when you touch a front-door handle.';
        maxlength = 220;
        output = 'The SmartAccess<span class="tooltip-trigger disclaimer" data-disclaimers="[{&quot;code&quot;:&quot;SMRTACCS&quot;,&quot;isTerms&quot;:false,&quot;body&quot;:&quot;The SmartAccess system may interfere with some pacemakers or cardiac defibrillators. If you have one of these medical devices, please talk to your doctor to see if you should deactivate this system.&quot;},{&quot;code&quot;:&quot;ENGIMM3&quot;,&quot;isTerms&quot;:false,&quot;body&quot;:&quot;The engine immobilizer is a state-of-the-art anti-theft system. When you insert your key into the ignition switch or bring a SmartAccess fob into the vehicle, the key transmits an electronic code to the vehicle. The engine will only start if the code in the transponder chip inside the key/fob matches the code in the vehicle&amp;apos;s immobilizer. Because the transponder chip is embedded in the key/fob, it can be costly to replace. If you lose a key or fob, your Lexus dealer can help. Alternatively, you can find a qualified independent locksmith to perform high-security key services by consulting your local &lt;em&gt;Yellow Pages&lt;/em&gt; or by contacting www.aloa.org.&quot;}]"><span class="asterisk">*</span></span><sup class="disclaimer-counters">30</sup> keyfob lets you lock and unlock your doors and start the push-button ignition—all without having to take your keys out of your pocket or purse. As soon as the sensors detect the presence of your'.length;
        assert.equal(rm.getIndexOfReadMoreBreak(testCopy, maxlength), output, "real world example.");

        testCopy = "Advanced voice command enables you to place compatible Bluetooth®<span class=\"tooltip-trigger disclaimer\" data-disclaimers=\"[{&quot;code&quot;:&quot;BLUETOOTH6&quot;,&quot;isTerms&quot;:false,&quot;body&quot;:&quot;The Bluetooth® word mark and logos are registered trademarks owned by Bluetooth SIG, Inc. and any use of such marks by Lexus is under license. Other trademarks and trade names are those of their respective owners. The phones on lexus.com have been tested for Bluetooth® wireless technology compatibility with Lexus vehicles. Performance will vary based on phone software version, coverage and your wireless carrier. &quot;}]\"><span class=\"asterisk\">*</span></span><sup class=\"disclaimer-counters\">32</sup>-enabled phone calls and operate climate, audio and navigation functions using normal, everyday speech. If you say \"It\'s too hot in here,\" for example, the climate control will automatically lower the temperature by four degrees. With Enhanced Bluetooth® technology<span class=\"tooltip-trigger disclaimer\" data-disclaimers=\"[{&quot;code&quot;:&quot;BLUETOOTH6&quot;,&quot;isTerms&quot;:false,&quot;body&quot;:&quot;The Bluetooth® word mark and logos are registered trademarks owned by Bluetooth SIG, Inc. and any use of such marks by Lexus is under license. Other trademarks and trade names are those of their respective owners. The phones on lexus.com have been tested for Bluetooth® wireless technology compatibility with Lexus vehicles. Performance will vary based on phone software version, coverage and your wireless carrier. &quot;}]\"><span class=\"asterisk\">*</span></span><sup class=\"disclaimer-counters\">33</sup>, compatible Bluetooth®<span class=\"tooltip-trigger disclaimer\" data-disclaimers=\"[{&quot;code&quot;:&quot;BLUETOOTH6&quot;,&quot;isTerms&quot;:false,&quot;body&quot;:&quot;The Bluetooth® word mark and logos are registered trademarks owned by Bluetooth SIG, Inc. and any use of such marks by Lexus is under license. Other trademarks and trade names are those of their respective owners. The phones on lexus.com have been tested for Bluetooth® wireless technology compatibility with Lexus vehicles. Performance will vary based on phone software version, coverage and your wireless carrier. &quot;}]\"><span class=\"asterisk\">*</span></span><sup class=\"disclaimer-counters\">34</sup> mobile-phone address-book contacts can be viewed and accessed on the Navigation System<span class=\"tooltip-trigger disclaimer\" data-disclaimers=\"[{&quot;code&quot;:&quot;VADVDHD&quot;,&quot;isTerms&quot;:false,&quot;body&quot;:&quot;Always drive safely, obey traffic laws &amp; focus on the road while driving. Availability and accuracy of the information provided by the Navigation System or any HD service is dependent upon many factors. Use common sense when relying on information provided. Services and programming subject to change. Services not available in every city or roadway. Navigation updates are available at an additional cost from your local Lexus dealer. See your &lt;em&gt;Navigation System &lt;/em&gt;&lt;em&gt;Owner&amp;apos;s Manual&lt;/em&gt; or Lexus dealer for details. HD Radio™ Technology manufactured under license from iBiquity Digital Corporation U.S. and Foreign Patents. HD Radio™ and the HD, HD Radio, and “Arc” logos are proprietary trademarks of iBiquity Digital Corp. &quot;}]\"><span class=\"asterisk\">*</span></span><sup class=\"disclaimer-counters\">35</sup> display or via voice command.";
        maxlength = 220;
        output = "Advanced voice command enables you to place compatible Bluetooth®<span class=\"tooltip-trigger disclaimer\" data-disclaimers=\"[{&quot;code&quot;:&quot;BLUETOOTH6&quot;,&quot;isTerms&quot;:false,&quot;body&quot;:&quot;The Bluetooth® word mark and logos are registered trademarks owned by Bluetooth SIG, Inc. and any use of such marks by Lexus is under license. Other trademarks and trade names are those of their respective owners. The phones on lexus.com have been tested for Bluetooth® wireless technology compatibility with Lexus vehicles. Performance will vary based on phone software version, coverage and your wireless carrier. &quot;}]\"><span class=\"asterisk\">*</span></span><sup class=\"disclaimer-counters\">32</sup>-enabled phone calls and operate climate, audio and navigation functions using normal, everyday speech. If you say \"It\'s too hot in here,\" for example,".length;
        assert.equal(rm.getIndexOfReadMoreBreak(testCopy, maxlength), output, "real world example.");

        testCopy = "The RES+<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES15\",\"isTerms\":false,\"body\":\"Purchase and installation of the RES+ accessory in your vehicle is required. To activate and use RES+ smartphone connected services requires registration, an annual subscription fee and app download. <strong>Includes One-Year Complimentary Subscription.</strong>\"},{\"code\":\"RES12\",\"isTerms\":false,\"body\":\"Use only if aware of circumstances surrounding the vehicle at time of start. Operate only when legal and safe to do so (e.g., car uncovered in open area, no people or pets inside or nearby). See usage precautions and <em>Owner&amp;apos;s</em> <em>Manual</em>.\"},{\"code\":\"RES3\",\"isTerms\":false,\"body\":\"RES+ comes with a warranty that is honored at all Lexus dealerships nationwide for up to 48 months/50,000 miles. See your Lexus dealer for specific warranty details.\"}]'><span class='asterisk'>*</span></span> (Remote Engine Starter+) features an unlimited range<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES4\",\"isTerms\":false,\"body\":\"The smartphone and vehicle must be in a location with adequate cellular coverage for proper performance.\"}]'><span class='asterisk'>*</span></span> and supports up to four smartphones<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES5\",\"isTerms\":false,\"body\":\"Phones supported include select iPhone&reg; and Android&trade; models. iPhone is a registered trademark of Apple Inc. Android is a trademark of Google Inc. Phones not included. To check current Lexus vehicle and smartphone compatibility with RES+, go to lexusdrivers.com. Click on the RES+ icon and then the &ldquo;Compatibility&rdquo; tab.\"}]'><span class='asterisk'>*</span></span>. It enables you to remotely start your engine<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES6\",\"isTerms\":false,\"body\":\"The SmartAccess fob can remotely start/stop the engine with a range limitation of approximately 80 feet.\"}]'><span class='asterisk'>*</span></span> which activates the climate control settings, remotely stop your engine<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES6\",\"isTerms\":false,\"body\":\"The SmartAccess fob can remotely start/stop the engine with a range limitation of approximately 80 feet.\"}]'><span class'asterisk'>*</span></span> (when the engine was initially turned on using RES+), locate your vehicle<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES7\",\"isTerms\":false,\"body\":\"CarFinder may not work in a covered or underground garage.\"},{\"code\":\"RES8\",\"isTerms\":false,\"body\":\"Objects and structures surrounding your vehicle and/or smartphone, such as tall buildings and roof structures, can block GPS signals and affect location accuracy.\"}]'><span class='asterisk'>*</span></span>, get the outside temperature near your vehicle, check the engine start/stop<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES2\",\"isTerms\":false,\"body\":\"For detailed functional restrictions and limitations, go to lexusdrivers.com and click on the RES+ icon. Next, click on &ldquo;Manual.&rdquo; Finally, under the heading &ldquo;FOR SMARTPHONE OPERATION,&rdquo; click on &ldquo;OPERATION PRIORITY OVERVIEW (PDF)&rdquo; and &ldquo;OPERATING CONDITIONS (PDF).&rdquo;\"}]'><span class='asterisk'>*</span></span> and door lock/unlock<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES2\",\"isTerms\":false,\"body\":\"For detailed functional restrictions and limitations, go to lexusdrivers.com and click on the RES+ icon. Next, click on &ldquo;Manual.&rdquo; Finally, under the heading &ldquo;FOR SMARTPHONE OPERATION,&rdquo; click on &ldquo;OPERATION PRIORITY OVERVIEW (PDF)&rdquo; and &ldquo;OPERATING CONDITIONS (PDF).&rdquo;\"}]'><span class='asterisk'>*</span></span> status and receive an e-mail if the theft-deterrent system is activated. Purchase and installation of the RES+ accessory in your vehicle, yearly subscription fee, smartphone app and registration are required. Includes One-Year Complimentary Subscription. For more information, visit lexusdrivers.com and click on the RES+ icon.";
        maxlength = 210;
        output = "The RES+<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES15\",\"isTerms\":false,\"body\":\"Purchase and installation of the RES+ accessory in your vehicle is required. To activate and use RES+ smartphone connected services requires registration, an annual subscription fee and app download. <strong>Includes One-Year Complimentary Subscription.</strong>\"},{\"code\":\"RES12\",\"isTerms\":false,\"body\":\"Use only if aware of circumstances surrounding the vehicle at time of start. Operate only when legal and safe to do so (e.g., car uncovered in open area, no people or pets inside or nearby). See usage precautions and <em>Owner&amp;apos;s</em> <em>Manual</em>.\"},{\"code\":\"RES3\",\"isTerms\":false,\"body\":\"RES+ comes with a warranty that is honored at all Lexus dealerships nationwide for up to 48 months/50,000 miles. See your Lexus dealer for specific warranty details.\"}]'><span class='asterisk'>*</span></span> (Remote Engine Starter+) features an unlimited range<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES4\",\"isTerms\":false,\"body\":\"The smartphone and vehicle must be in a location with adequate cellular coverage for proper performance.\"}]'><span class='asterisk'>*</span></span> and supports up to four smartphones<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES5\",\"isTerms\":false,\"body\":\"Phones supported include select iPhone&reg; and Android&trade; models. iPhone is a registered trademark of Apple Inc. Android is a trademark of Google Inc. Phones not included. To check current Lexus vehicle and smartphone compatibility with RES+, go to lexusdrivers.com. Click on the RES+ icon and then the &ldquo;Compatibility&rdquo; tab.\"}]'><span class='asterisk'>*</span></span>. It enables you to remotely start your engine<span class='tooltip-trigger disclaimer' data-disclaimers='[{\"code\":\"RES6\",\"isTerms\":false,\"body\":\"The SmartAccess fob can remotely start/stop the engine with a range limitation of approximately 80 feet.\"}]'><span class='asterisk'>*</span></span> which activates the climate control settings, remotely stop".replace('\"', '"').length;
        assert.equal(rm.getIndexOfReadMoreBreak(testCopy, maxlength), output, "real world example: disclaimers with HTMl.");

        assert.equal(rm.getIndexOfReadMoreBreak("FOO bar<span>*</span> baz bop.", "FOO bar* baz".length), "FOO bar<span>*</span> baz".length, "ignore tags");
        assert.equal(rm.getIndexOfReadMoreBreak("FOO bar<span>*</span> baz bop.", "FOO bar*".length), "FOO bar<span>*</span>".length, "if the break happens in the tag at the last character, include the closing tag");
//        equal(rm.getIndexOfReadMoreBreak("FOO bar <span>A B C</span> baz bop.", "FOO bar A B".length), "FOO bar".length, "don't break up a tag");

        assert.equal(rm.getIndexOfReadMoreBreak("<b>FOO</b> bar<strong>*</strong> baz bop.", "FOO bar*".length), "<b>FOO</b> bar<strong>*</strong>".length, "Support for b and strong.");
    });

    QUnit.test("getTextBeforeAndAfterSplit", function(assert) {
        var rm = ReadMore();
        assert.deepEqual (rm.getTextBeforeAndAfterSplit("a b", "a".length), {beforeSplit:"a", afterSplit:" b"}, "getTextBeforeAndAfterSplit splits the text using the truncate function.");
        assert.deepEqual (rm.getTextBeforeAndAfterSplit("abc def", "abc d".length), {beforeSplit:"abc", afterSplit:" def"}, "getTextBeforeAndAfterSplit doesn't split whoel words.");

        assert.deepEqual (rm.getTextBeforeAndAfterSplit("<b>bold</b> not bold", "bold".length), {beforeSplit:"<b>bold</b>", afterSplit:" not bold"}, "getTextBeforeAndAfterSplit doesn't affect html tags.");
    });

});
